---
title: "Project Outline"
author: "Veena Advani"
date: "4/18/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library("foreign")
library("dplyr")
library("tidyr")
library("countrycode")
library("rworldmap")
library(ggplot2)
library(reshape2)
library(FNN)
```

### Changes to Dataset from Last time
```{r}
#To start, let's read in the cleaned datasets from our last submission:
teacher_data <- read.csv("TALIS.csv")
subject_data <- read.csv("subject_data.csv", as.is=TRUE)

#change column names of 10 satisfaction questions to make more readable
indices <- grep("TT2G46", colnames(teacher_data))[-11]
colnames(teacher_data)[indices] <- c("sat1", "sat2", "sat3", "sat4", "sat5", "sat6", "sat7", "sat8", "sat9", "sat10")
names(teacher_data)[names(teacher_data)=="TT2G46_avg"] <- "sat_avg"

#Column "TT2G15" contains no useful data, since it's all NAs, so we're going to remove it
teacher_data <- teacher_data[, -24]

#Column "ID" is no longer necessary, was used for making the subject dataset
teacher_data <- teacher_data[, -36]

#change some of the subject names (one of the comments in our dataset submission was that they weren't clear):
names(teacher_data)[names(teacher_data) == "For_Lang"] <- "Modern_Lang"
names(teacher_data)[names(teacher_data) == "Gk_Ln"] <- "Ancient_Lang"

#We also thought it might be useful to have a variable that indicates the number of subjects a given teacher teaches, so let's add it below:
teacher_data$num_subjects <- rowSums(teacher_data[,24:35], na.rm=TRUE)

#We discussed in our dataset submission why we weren't going to use their teacher satisfaction variable, and were instead going to use the average of the 10 satisfaction questions:
teacher_data <- teacher_data[, -13]
```

A lot of the variables stored as categorical variables with the categories "Strongly Disagree", "Disagree", "Strongly Agree", and "Agree", are currently factors.  Given that these categories do have a natural ordering, we're going to convert them into ordered factors.

```{r}
teacher_data$prep_A <- factor(teacher_data$prep_A, levels=c("Not at all", "Somewhat", "Well", "Very well"), ordered=TRUE)
teacher_data$prep_B <- factor(teacher_data$prep_B, levels=c("Not at all", "Somewhat", "Well", "Very well"), ordered=TRUE)
teacher_data$prep_C <- factor(teacher_data$prep_C, levels=c("Not at all", "Somewhat", "Well", "Very well"), ordered=TRUE)

teacher_data$feedback_salary <- factor(teacher_data$feedback_salary, levels=c("No positive change", "A small change", "A moderate change", "A large change"), ordered=TRUE)

teacher_data$collab <- factor(teacher_data$collab, levels=c("Strongly disagree", "Disagree", "Agree", "Strongly agree"), ordered=TRUE)
```


We'll split the country data into regions using the World Health Organization  categories, so that we can try to find regional patterns

```{r}
summary(teacher_data$country)
# Brazil, Chile
teacher_data$region[teacher_data$country %in% c("BRA", "CHL")] <- "South America"
# Canada, Mexico, United States
teacher_data$region[teacher_data$country %in% c("CAB", "MEX", "USA")] <- "North America"
# Belgium, Bulgaria, Czech Republic, Denmark, England, Spain, Estonia, Finland, France, Georgia, Croatia, Israel, Italy, Latvia, Netherlands, Norway, Poland, Portugal, Romania, Russia, Serbia, Slovak Republic, Sweden
teacher_data$region[teacher_data$country %in% 
                        c("BFL", "BGR", "CZE", "DNK", "ENG", "ESP", "EST", "FIN", "FRA", "GEO", "HRV", "ISR", "ITA", "LVA", "NLD", "NOR", "POL", "PRT", "ROU", "RUS", "SRB", "SVK", "SWE")] <- "European"
# Abu Dhabi,                     
teacher_data$region[teacher_data$country %in% c("AAD")] <- "Eastern Mediterranean"
# Australia, China, Japan, South Korea, Malaysia, New Zealand, Singapore
teacher_data$region[teacher_data$country %in% c("AUS", "CSH", "JPN", "KOR", "MYS", "NZL", "SGP")] <- "Western Pacific"
teacher_data$region <- as.factor(teacher_data$region)
summary(teacher_data$region)
```

We can take a look at average satisfaction by region.

```{r}
teacher_data %>% filter(!is.na(sat_avg)) %>% ggplot(aes(x=reorder(region, -sat_avg, median), y=sat_avg)) + geom_boxplot()
```


### Introduction


This analysis will focus on the Teaching and Learning International Survey (TALIS) Dataset.
Some information about TALIS:

* It aimed to collect information on teaching profession, working conditions, and learning environments of schools
* One goal was to come up with metrics and information that would enable comparisons across countries
* It focused on SCED* Level 2 schools (lower secondary schools)
* At selected schools, the principal (or head administrator) and a random selection of up to 22 teachers were chosen to complete voluntary online questionnaires
* There are 36 countries in the dataset (some of which are non-English speaking countries). The only country requirement was that participating countries must be industrialized.

#### Main Research Questions:
(1) Which variables and classroom factors are the best predictors of teacher job satisfaction?
(2) How do teacher satisfaction, as well as some of the significant predictors found from question 1, vary by country?

#### Motivation of Study:
* Education is important to any country's basic development and functioning
* There is a fair amount of diversity across countries with regard to how well the teaching profession is respected, as well as how much countries fund their education systems.
* As a result, teacher working conditions vary quite a bit
* However, in order to make sure that there are enough teachers, and that they are able to teach their students well, it is important that teacher satisfaction is at a high enough level.  If teacher satisfaction is too low, it becomes difficult to retain a large enough teaching force
* Therefore, understanding how teacher satisfaction varies across the 36 countries in the data set, and which aspects of a school and environment correlate most with teacher satisfaction, could be helpful information in order to make sure that countries have enough teachers, and that teachers have enough resources to do their jobs well.

### Data

Each row of the dataset is for a single teacher's response to the questionairre.  Each column in the dataset corresponds to either a particular question in the questionairre, or a summary variable for a section of the questionairre.

The variables we are using are:

* `country (CNTRY):` Country of teacher (factor variable, 36 levels)
* `region:` Region the teacher's country is in (factor variable, 8 levels)
* `gender (TT2G01):` Teacher Gender (factor variable, 2 levels)
* `age (TT2G02):` Teacher Age (numeric variable)
* `years_teacher (TT2G05B):` Years of teaching experience (numeric variable)
* `train_stat (TT2G11):` Training level of teacher (factor variable)
* `prep_A/B/C (TT2G13A/B/C):` How prepared the teacher felt (factor variable, 4 levels)
* `total_time (TT2G16):` Total time spent on teaching related activities in hours per week (numeric variable)
* `feedback_salary (TT2G30G):` Whether performance feedback influences salary (factor variable, 4 levels)
* `collab (TT2G44E):` How collaborative is the school culture? (factor variable, 4 levels)
* `num_students (TT2G38):` Number of students in the teacherâ€™s class (numeric variable)
* `satisfaction (TJOBSATS):` Self rated teacher job satisfaction (factor variable, 4 levels)
* `Various Subject Names (TT2G15[A - L]):` 12 columns representing which subjects the teacher teaches (boolean numeric variable)
* `num_subjects:` The number of subjects the teacher teaches (numeric variable)
* `sat1-sat10 (TT2G46[A - J]):` Ten questions related to teacher job satisfaction (factor variables, 4 levels)
* `sat_avg:` An average of the ten questions related to teacher job satisfaction (numeric variable)

#### Initial Plots Describing Data

Below are three plots that show our data and hopefully motivate our research questions and the analysis.

##### Plot 1: Teacher Age vs Years of Teaching Experience
First, we look at a plot of age vs years teacher.
```{r}
teacher_data %>% ggplot(aes(x=age, y=years_teacher, color=gender)) + geom_point(alpha=0.5,shape=".") + geom_abline(intercept =0, slope=1) +  geom_jitter(alpha=0.5,shape=".")
```

Right away, we can see that there are a number of outliers who appear to have been teaching longer than they've been alive. These are the points above the black line, which represents y=x.

```{r}
teacher_data$age_start <- teacher_data$age - teacher_data$years_teacher
sum(na.omit(teacher_data$age_start) <= 0)
```

Although it doesn't really make sense for people to have started working as a teacher at age 5 either. Let's take a look at how many respondents said they started teaching before age 15 and 21. 
```{r}
teacher_data %>% ggplot(aes(x=age, y=years_teacher, color=gender)) + geom_point(alpha= 0.5, shape=".") + geom_abline(intercept = -15, slope=1) + geom_abline(intercept = -21, slope=1) 
```

```{r}
sum(na.omit(teacher_data$age_start) <= 15)
```

```{r}
teacher_data %>% ggplot(aes(x=age, y=years_teacher, color=country)) + geom_point(alpha= 0.5, shape=".") + geom_smooth(method="lm", se=F)
```

##### Plot 2: Teacher Satisfaction vs Collaboration Level of the School
```{r}
teacher_data %>% filter(!is.na(collab)) %>% ggplot(aes(x=collab, y=sat_avg)) + geom_boxplot()
```


##### Plot 3: 
### Analysis for Research Question 1

To address our first research question, and try to identify which variables are the best indicators of teacher job satisfaction, we are going to try several techniques.

#### Linear Regression Analysis
(1) We are first going to run two linear regression models.  One with all of the predictors in the dataset, and one with all of the predictors that have NA values in less than 5% of observations.
(2) We are going to use forward, backwards and bidirectional stepwise selection, and look at the linear models that end up getting chosen from those three methods.
(3) We will then look at which predictors appeared to be the most significant in the linear models from (1) and (2).  Based on this, we will perform one-way ANOVA tests with each of these predictors, and graph these variables against our job satisfaction (sat_avg) variable to get a better idea of the relationship between those predictors and our response variable.

```{r}
sat_indices <- grep("sat", names(teacher_data))[-11]
#some columns also have many more NA values, lets make a list of those so we can choose whether or not to include them in our linear models
na_cols <- c(10,11)
subject_indices <- c(23:34)
#For the linear model with most of the predictors, let's remove the columns with a large number of na values.  
#Let's also remove the columns that correspond to the 10 satisfaction questions, since they were used to create the sat_avg variable (our response variable)
#Let's also remove the subject columns, since we have a column that stores the number of subjects each teacher is teaching
m1 <- lm(sat_avg ~ ., data=teacher_data[,-c(na_cols, sat_indices, subject_indices)])
summary(m1)
```

Using stepwise regression
```{r}
# remove SAT questions, since they obviously explain our predictor variable, and then remove NAs for stepwise regression
#also remove subject columns, we have a column that counts the number of subjects each teacher is teaching, to represent this information instead.
x <- na.omit(teacher_data[, -c(sat_indices, na_cols, subject_indices)])
m.full <- lm(sat_avg ~., data=x)
m.empty <- lm(sat_avg ~ 1, data=x)
```

Forward, backwards, and both
```{r}
m.forward <- step(m.empty, scope=list(upper=m.full),
                  data=x, direction="forward", trace=FALSE)
m.backward <- step(m.full, scope=list(lower=m.empty),
                  data=x, direction="backward", trace=FALSE)
m.both <- step(m.empty, scope=list(upper=m.full),
                  data=x, direction="both", trace=FALSE)
```


#### One-way Anova Tests
TODO after the analysis above is completed.

Some potential candidates for predictors are: 

collab, prep_C, and region


#### Logistic Regression Analysis

Logistic Regression:

In addition to using linear regression, we will also then convert our job satisfaction variable into a categorical variable with 2 categories, "satisfied" and "unsatisfied".  We will then see if Logistic Regression yields slightly different results than our Linear Regression approach.

For Logistic Regression we will:
(1) Try a full model, with all the predictors
(2) Try forwards, backwards and bidirectional stepwise selection

Then we will analyze the models from (1) and (2) to try to determine which columns are the best predictors of whether or not teachers are satisfied, and compare these results to the results we got from linear regression.

### Analysis for Research Question 2